<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medieval Battle RPG</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="game-wrapper">

    <!-- TELA DE CARREGAMENTO PARA EVITAR O "FLASH" -->
    <div id="loading-screen" class="screen active">
        <h1>Medieval Battle RPG</h1>
        <p>Conectando ao servidor...</p>
    </div>
    
    <!-- TELA INICIAL DO LOBBY DO GM -->
    <div id="gm-initial-lobby" class="screen">
        <h1>Lobby do Mestre</h1>
        <p>Envie o link de convite para os participantes.</p>
        <div class="gm-links-container">
            <div>
                <h3>Link de Convite:</h3>
                <div id="gm-link-invite" class="share-link" title="Clique para copiar">Gerando...</div>
            </div>
        </div>
        <div id="gm-lobby-status-container">
            <h3>Jogadores Conectados:</h3>
            <ul id="gm-lobby-player-list"></ul>
        </div>
        <div class="mode-buttons-container">
            <button id="start-adventure-btn" class="mode-btn">Iniciar Aventura</button>
            <button id="start-theater-btn" class="mode-btn">Modo Cen√°rio</button>
        </div>
    </div>
    
    <!-- TELA DE ESCOLHA DE PAPEL -->
    <div id="role-selection-screen" class="screen">
        <h1>Bem-vindo!</h1>
        <p>Como voc√™ deseja entrar na sala?</p>
        <div class="mode-buttons-container">
            <button id="join-as-player-btn" class="mode-btn">Jogar</button>
            <button id="join-as-spectator-btn" class="mode-btn">Assistir</button>
        </div>
        <p id="room-full-message" class="hidden" style="margin-top: 20px; color: #ffc107;"></p>
    </div>

    <!-- NOVA TELA: ESCOLHA INICIAL DO JOGADOR (NOVO/CARREGAR) -->
    <div id="player-initial-choice-screen" class="screen">
        <h1>Cria√ß√£o de Personagem</h1>
        <p>Como deseja prosseguir?</p>
        <div class="mode-buttons-container">
            <button id="new-char-btn" class="mode-btn">Novo Personagem</button>
            <button id="load-char-btn" class="mode-btn">Carregar Personagem</button>
            <input type="file" id="load-char-input" class="hidden" accept=".txt,.json">
        </div>
    </div>

    <!-- TELA DE SELE√á√ÉO DE PERSONAGENS (TOKEN) -->
    <div id="selection-screen" class="screen">
        <h1 id="selection-title">Selecione seu Personagem (Token)</h1>
        <div id="character-list-container"></div>
        <button id="confirm-selection-btn">Confirmar Token</button>
    </div>

    <!-- NOVA TELA: FICHA DE CRIA√á√ÉO DE PERSONAGEM -->
    <div id="character-sheet-screen" class="screen">
        <div class="sheet-container">
            <div class="sheet-header">
                <h1>Ficha de Personagem</h1>
            </div>

            <div class="sheet-main-info">
                <div class="sheet-field">
                    <label for="sheet-name">Nome:</label>
                    <input type="text" id="sheet-name" placeholder="Nome do Personagem">
                </div>
                <div class="sheet-field">
                    <label for="sheet-class">Classe:</label>
                    <input type="text" id="sheet-class" placeholder="Ex: Guerreiro, Mago (Opcional)">
                </div>
                <div class="sheet-field">
                    <label for="sheet-race-select">Ra√ßa:</label>
                    <select id="sheet-race-select"></select>
                </div>
            </div>

            <div class="sheet-calculated-stats">
                <div class="stat-box">
                    <h4>ESQUIVA (ESQ)</h4>
                    <span id="sheet-esq" class="stat-value">10</span>
                </div>
                <div class="stat-box">
                    <h4>B√¥nus Total Acerto</h4>
                    <span id="sheet-bta" class="stat-value">+0</span>
                </div>
                <div class="stat-box">
                    <h4>B√¥nus Total Dano</h4>
                    <span id="sheet-btd" class="stat-value">+0</span>
                </div>
                <div class="stat-box">
                    <h4>B√¥nus Total M√°gico</h4>
                    <span id="sheet-btm" class="stat-value">+0</span>
                </div>
            </div>

            <div class="sheet-columns">
                <!-- COLUNA DA ESQUERDA -->
                <div class="sheet-column">
                    <div class="sheet-section life-bars">
                        <div class="bar-container">
                            <label>VIDA (HP)</label>
                            <div class="bar-value"><span id="sheet-hp-current">20</span> / <span id="sheet-hp-max">20</span></div>
                        </div>
                        <div class="bar-container">
                            <label>MAHOU / KI</label>
                            <div class="bar-value"><span id="sheet-mahou-current">10</span> / <span id="sheet-mahou-max">10</span></div>
                        </div>
                    </div>

                    <div class="sheet-section">
                        <h3>Elementos <small>(<span id="sheet-points-elem-remaining">2</span> pontos) <span class="error-message" id="elem-error-message"></span></small></h3>
                        <div class="attributes-grid elements-grid">
                            <div class="attr-item"> <label>Fogo</label> <div class="number-input-wrapper"><button class="arrow-btn down-arrow">-</button><input type="number" id="sheet-elem-fogo" min="0" max="2" value="0"><button class="arrow-btn up-arrow">+</button></div> <div class="advanced-element-display" id="advanced-fogo"></div> </div>
                            <div class="attr-item"> <label>√Ågua</label> <div class="number-input-wrapper"><button class="arrow-btn down-arrow">-</button><input type="number" id="sheet-elem-agua" min="0" max="2" value="0"><button class="arrow-btn up-arrow">+</button></div> <div class="advanced-element-display" id="advanced-agua"></div> </div>
                            <div class="attr-item"> <label>Terra</label> <div class="number-input-wrapper"><button class="arrow-btn down-arrow">-</button><input type="number" id="sheet-elem-terra" min="0" max="2" value="0"><button class="arrow-btn up-arrow">+</button></div> <div class="advanced-element-display" id="advanced-terra"></div> </div>
                            <div class="attr-item"> <label>Vento</label> <div class="number-input-wrapper"><button class="arrow-btn down-arrow">-</button><input type="number" id="sheet-elem-vento" min="0" max="2" value="0"><button class="arrow-btn up-arrow">+</button></div> <div class="advanced-element-display" id="advanced-vento"></div> </div>
                            <div class="attr-item"> <label>Luz</label> <div class="number-input-wrapper"><button class="arrow-btn down-arrow">-</button><input type="number" id="sheet-elem-luz" min="0" max="2" value="0"><button class="arrow-btn up-arrow">+</button></div> <div class="advanced-element-display" id="advanced-luz"></div> </div>
                            <div class="attr-item"> <label>Escurid√£o</label> <div class="number-input-wrapper"><button class="arrow-btn down-arrow">-</button><input type="number" id="sheet-elem-escuridao" min="0" max="2" value="0"><button class="arrow-btn up-arrow">+</button></div> <div class="advanced-element-display" id="advanced-escuridao"></div> </div>
                        </div>
                    </div>
                    
                    <div class="sheet-section">
                        <h3 id="attribute-points-header">Atributos B√°sicos <small>(<span id="sheet-points-attr-remaining">5</span> pontos) <span class="error-message" id="attr-error-message"></span></small></h3>
                        <div class="attributes-grid">
                            <div class="attr-item"> <label>For√ßa</label> <div class="number-input-wrapper"><button class="arrow-btn down-arrow">-</button><input type="number" id="sheet-base-attr-forca" min="0" value="0"><button class="arrow-btn up-arrow">+</button></div> </div>
                            <div class="attr-item"> <label>Agilidade</label> <div class="number-input-wrapper"><button class="arrow-btn down-arrow">-</button><input type="number" id="sheet-base-attr-agilidade" min="0" value="0"><button class="arrow-btn up-arrow">+</button></div> </div>
                            <div class="attr-item"> <label>Prote√ß√£o</label> <div class="number-input-wrapper"><button class="arrow-btn down-arrow">-</button><input type="number" id="sheet-base-attr-protecao" min="0" value="0"><button class="arrow-btn up-arrow">+</button></div> </div>
                            <div class="attr-item"> <label>Constitui√ß√£o</label> <div class="number-input-wrapper"><button class="arrow-btn down-arrow">-</button><input type="number" id="sheet-base-attr-constituicao" min="0" value="0"><button class="arrow-btn up-arrow">+</button></div> </div>
                            <div class="attr-item"> <label>Intelig√™ncia</label> <div class="number-input-wrapper"><button class="arrow-btn down-arrow">-</button><input type="number" id="sheet-base-attr-inteligencia" min="0" value="0"><button class="arrow-btn up-arrow">+</button></div> </div>
                            <div class="attr-item"> <label>Mente</label> <div class="number-input-wrapper"><button class="arrow-btn down-arrow">-</button><input type="number" id="sheet-base-attr-mente" min="0" value="0"><button class="arrow-btn up-arrow">+</button></div> </div>
                        </div>
                    </div>
                </div>

                <!-- COLUNA DA DIREITA -->
                <div class="sheet-column">
                     <div class="sheet-section">
                        <h3>Atributos Finais <small>(com b√¥nus/penalidades)</small></h3>
                        <div class="attributes-grid final-attributes">
                            <div class="attr-item"> <label>For√ßa</label> <span id="sheet-final-attr-forca">0</span> </div>
                            <div class="attr-item"> <label>Agilidade</label> <span id="sheet-final-attr-agilidade">0</span> </div>
                            <div class="attr-item"> <label>Prote√ß√£o</label> <span id="sheet-final-attr-protecao">0</span> </div>
                            <div class="attr-item"> <label>Constitui√ß√£o</label> <span id="sheet-final-attr-constituicao">0</span> </div>
                            <div class="attr-item"> <label>Intelig√™ncia</label> <span id="sheet-final-attr-inteligencia">0</span> </div>
                            <div class="attr-item"> <label>Mente</label> <span id="sheet-final-attr-mente">0</span> </div>
                        </div>
                    </div>
                    <div id="sheet-equipment-section" class="sheet-section">
                        <h3>Equipamentos</h3>
                        <div class="equipment-grid">
                            <div class="equip-item">
                                <div id="sheet-weapon1-image" class="equipment-image-display"></div>
                                <div class="equip-controls">
                                    <label for="sheet-weapon1-name">Arma 1</label>
                                    <input type="text" id="sheet-weapon1-name" placeholder="Nome da Arma">
                                    <select id="sheet-weapon1-type"></select>
                                </div>
                            </div>
                            <div class="equip-item">
                                <div id="sheet-weapon2-image" class="equipment-image-display"></div>
                                <div class="equip-controls">
                                    <label for="sheet-weapon2-name">Arma 2</label>
                                    <input type="text" id="sheet-weapon2-name" placeholder="Nome da Arma">
                                    <select id="sheet-weapon2-type"></select>
                                </div>
                            </div>
                            <div class="equip-item">
                                <div id="sheet-armor-image" class="equipment-image-display"></div>
                                <div class="equip-controls">
                                    <label for="sheet-armor-type">Armadura</label>
                                    <select id="sheet-armor-type"></select>
                                </div>
                            </div>
                            <div class="equip-item">
                                <div id="sheet-shield-image" class="equipment-image-display"></div>
                                <div class="equip-controls">
                                    <label for="sheet-shield-type">Escudo</label>
                                    <select id="sheet-shield-type"></select>
                                </div>
                            </div>
                        </div>
                         <div class="money-container">
                            Dinheiro: <span id="sheet-money-copper">200</span> moedas de cobre
                        </div>
                         <p id="equipment-info-text" class="info-text"></p>
                    </div>
                     <div class="sheet-section">
                        <h3>Informa√ß√µes Raciais</h3>
                        <div id="race-info-box" class="info-box">Selecione uma ra√ßa para ver os detalhes.</div>
                    </div>
                     <div class="sheet-section">
                        <h3>Magias Iniciais (Grau 1) <small>(<span id="sheet-spells-selected-count">0</span>/2 selecionadas)</small></h3>
                        <div id="spell-info-box" class="info-box">
                            <div id="spell-selection-grid"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sheet-footer">
                <button id="sheet-save-btn" class="sheet-btn">Salvar Ficha</button>
                <button id="sheet-confirm-btn" class="sheet-btn confirm">Concluir e Jogar</button>
            </div>
        </div>
    </div>


    <!-- Tela para o GM confirmar o grupo e definir stats (SER√Å REMOVIDA/ADAPTADA FUTURAMENTE) -->
    <div id="gm-party-setup-screen" class="screen">
        <h1>Definir Atributos do Grupo</h1>
        <p>Defina a Agilidade (AGI) e Resist√™ncia (RES) para cada aventureiro.</p>
        <div id="gm-party-list" class="party-list-container"></div>
        <button id="gm-confirm-party-btn" class="mode-btn">Confirmar Grupo e Preparar Inimigos</button>
    </div>

    <!-- Tela para o GM selecionar os NPCs e definir stats -->
    <div id="gm-npc-setup-screen" class="screen">
        <h1>Montar Encontro</h1>
        <p>Clique em um slot vago e depois em um inimigo para adicion√°-lo.</p>

        <div class="npc-setup-layout">
            <div id="npc-staging-area-container">
                <h3>Inimigos na Batalha:</h3>
                <div id="npc-staging-area"></div>
            </div>
            <div class="npc-selection-wrapper">
                 <div id="npc-selection-area"></div>
            </div>
        </div>
        
        <button id="gm-start-battle-btn" class="mode-btn">Iniciar Batalha!</button>
    </div>

    <!-- TELA DE ESPERA DO JOGADOR/ESPECTADOR -->
    <div id="player-waiting-screen" class="screen">
         <h1>Medieval Battle RPG</h1>
         <p id="player-waiting-message">Aguardando o Mestre iniciar o jogo...</p>
    </div>
    
    <!-- TELA DE LUTA -->
    <div id="fight-screen" class="screen">
        <div id="waiting-players-sidebar"></div> 
        <div id="fight-scene-characters"></div>
        <div id="turn-order-sidebar"></div>
        <div id="fight-log-container">
            <h2 id="round-info">ROUND 1</h2>
            <div id="fight-log"></div>
        </div>
        <div id="initiative-ui" class="hidden">
            <button id="player-roll-initiative-btn" class="initiative-btn hidden">Rolar Iniciativa</button>
            <button id="gm-roll-initiative-btn" class="initiative-btn hidden">Rolar para Inimigos</button>
        </div>
        <div id="targeting-indicator" class="hidden">Selecione um alvo! (Clique direito ou ESC para cancelar)</div>
        <div id="action-buttons-wrapper"></div>
    </div>

    <!-- MODO CEN√ÅRIO -->
    <div id="theater-screen" class="screen">
        <div id="theater-background-viewport">
            <div id="theater-world-container">
                <img id="theater-background-image" src="" alt="Cen√°rio do Teatro">
                <div id="theater-token-container"></div>
            </div>
            <div id="selection-box" class="hidden"></div>
        </div>
        <button id="toggle-gm-panel-btn" class="toggle-gm-panel-btn hidden" title="Mostrar/Ocultar Painel">‚ò∞</button>
        <div id="theater-gm-panel" class="hidden">
            <div class="panel-section">
                <h4>Personagens</h4>
                <div id="theater-char-list"></div>
            </div>
            <div class="panel-section">
                <h4>Controles Gerais</h4>
                <label for="theater-global-scale">Escala Global:</label>
                <input type="range" id="theater-global-scale" min="0.2" max="3" step="0.1" value="1">
                <button id="theater-change-scenario-btn">Mudar Cen√°rio</button>
                <button id="theater-publish-btn" class="hidden">Publicar Cena</button>
            </div>
             <div class="panel-section" id="theater-gm-legend">
                <h4>Atalhos (GM)</h4>
                <p><b>G:</b> Sele√ß√£o em Grupo</p>
                <p><b>M:</b> Debug de Combate</p>
                <p><b>F:</b> Virar Personagem</p>
                <p><b>Setas ‚Üë‚Üì:</b> Mudar Camada</p>
                <p><b>Delete:</b> Excluir</p>
                <p><b>O (hover):</b> Resetar Tamanho</p>
                <p><b>Scroll (hover):</b> Mudar Tamanho</p>
            </div>
        </div>
    </div>

    <!-- MODAL PADR√ÉO -->
    <div id="modal" class="hidden">
        <div id="modal-content">
            <h3 id="modal-title">T√≠tulo</h3>
            <div id="modal-text">Texto.</div>
            <button id="modal-button">OK</button>
        </div>
    </div>

    <!-- MODAL DA LOJA -->
    <div id="shop-modal" class="hidden">
        <div id="shop-modal-content">
             <!-- O conte√∫do ser√° gerado dinamicamente pelo client.js -->
        </div>
    </div>

    <!-- MODAL DE SELE√á√ÉO DE IMAGEM DE ARMA -->
    <div id="weapon-image-modal" class="hidden">
        <div id="weapon-image-modal-content">
            <h3 id="weapon-image-modal-title">Selecione a Apar√™ncia da Arma</h3>
            <div id="weapon-image-modal-body">
                <!-- Conte√∫do ser√° populado via JS -->
            </div>
            <button id="weapon-image-modal-cancel">Cancelar</button>
        </div>
    </div>
    
    <!-- BOT√ïES FLUTUANTES -->
    <button id="back-to-lobby-btn" class="back-btn hidden" title="Voltar ao Lobby">‚åÇ</button>
    <div id="floating-buttons-container" class="hidden">
        <button id="floating-invite-btn" title="Convidar Jogador">‚úâÔ∏è</button>
        <button id="floating-switch-mode-btn" title="Mudar Modo de Jogo">üîÑ</button>
        <button id="floating-help-btn" title="Ajuda (Atalhos)">?</button>
    </div>

    <!-- Janela de Coordenadas -->
    <div id="coords-display" class="hidden"></div>

    <!-- WIDGET DE INFORMA√á√ïES DO JOGADOR -->
    <div id="player-info-widget" class="hidden">
        <div id="player-info-token"></div>
        <span id="player-info-name"></span>
    </div>

    <!-- MODAL DA FICHA DE PERSONAGEM EM JOGO -->
    <div id="ingame-sheet-modal" class="hidden">
        <div class="sheet-container ingame-sheet">
            <div class="sheet-header">
                <h1 id="ingame-sheet-name">Ficha de Personagem</h1>
                <button id="ingame-sheet-close-btn" class="close-btn">&times;</button>
            </div>
            
            <div class="ingame-sheet-scrollable-content">
                <div class="ingame-sheet-top-section">
                    <div class="ingame-sheet-main-stats">
                        <div id="ingame-sheet-token"></div>
                        <div class="ingame-sheet-level-xp">
                            <div class="level-box">N√≠vel: <span id="ingame-sheet-level">1</span></div>
                            <div class="xp-box">XP: <span id="ingame-sheet-xp">0</span> / <span id="ingame-sheet-xp-needed">100</span></div>
                        </div>
                    </div>
                    <div class="ingame-sheet-equipment">
                        <div class="sheet-section life-bars ingame-life-bars">
                            <div class="bar-container">
                                <label>VIDA (HP)</label>
                                <div class="bar-value"><span id="ingame-sheet-hp-current">20</span> / <span id="ingame-sheet-hp-max">20</span></div>
                            </div>
                            <div class="bar-container">
                                <label>MAHOU / KI</label>
                                <div class="bar-value"><span id="ingame-sheet-mahou-current">10</span> / <span id="ingame-sheet-mahou-max">10</span></div>
                            </div>
                        </div>
                        <h3>Equipamento Ativo</h3>
                        <div class="equipment-grid">
                            <div class="equip-item">
                                <div id="ingame-sheet-weapon1-image" class="equipment-image-display"></div>
                                <div class="equip-controls">
                                    <label for="ingame-sheet-weapon1-type">Arma 1</label>
                                    <select id="ingame-sheet-weapon1-type"></select>
                                </div>
                            </div>
                            <div class="equip-item">
                                <div id="ingame-sheet-weapon2-image" class="equipment-image-display"></div>
                                <div class="equip-controls">
                                    <label for="ingame-sheet-weapon2-type">Arma 2</label>
                                    <select id="ingame-sheet-weapon2-type"></select>
                                </div>
                            </div>
                            <div class="equip-item">
                                <div id="ingame-sheet-armor-image" class="equipment-image-display"></div>
                                <div class="equip-controls">
                                    <label for="ingame-sheet-armor-type">Armadura</label>
                                    <select id="ingame-sheet-armor-type"></select>
                                </div>
                            </div>
                            <div class="equip-item">
                                <div id="ingame-sheet-shield-image" class="equipment-image-display"></div>
                                <div class="equip-controls">
                                    <label for="ingame-sheet-shield-type">Escudo</label>
                                    <select id="ingame-sheet-shield-type"></select>
                                </div>
                            </div>
                        </div>
                        <div id="ingame-sheet-ammunition" class="hidden">
                            <h4>Muni√ß√£o</h4>
                            <div id="ingame-sheet-ammo-list"></div>
                        </div>
                        <p id="ingame-equipment-info-text" class="info-text"></p>
                    </div>
                </div>

                <div class="sheet-columns">
                    <div class="sheet-column">
                        <div class="sheet-section">
                             <h3>Atributos <span id="ingame-attribute-points-dist-header" class="hidden point-dist-label"> | Pontos de Atributo: <span id="ingame-attr-points-avail">0</span></span></h3>
                            <div class="attributes-grid" id="ingame-sheet-attributes">
                                <!-- Populado por JS -->
                            </div>
                        </div>
                        <div class="sheet-section">
                             <h3>Elementos <span id="ingame-element-points-dist-header" class="hidden point-dist-label"> | Pontos de Elemento: <span id="ingame-elem-points-avail">0</span></span></h3>
                            <div class="attributes-grid elements-grid" id="ingame-sheet-elements">
                                <!-- Populado por JS -->
                            </div>
                        </div>
                        <div class="sheet-section">
                            <h3>Magias</h3>
                            <div id="ingame-sheet-spells-grid">
                                <!-- Populado por JS -->
                            </div>
                            <div id="ingame-spell-choices-dist" class="hidden">
                                <!-- Populado por JS -->
                            </div>
                        </div>
                        <button id="ingame-confirm-points-btn" class="sheet-btn confirm hidden">Confirmar Distribui√ß√£o</button>
                    </div>
                    <div class="sheet-column">
                        <div class="inventory-header">
                            <h3>Invent√°rio</h3>
                            <div class="money-container ingame-money">
                                Dinheiro: <span id="ingame-sheet-money">0</span> moedas
                            </div>
                        </div>
                        <div id="inventory-grid">
                            <!-- Populado por JS -->
                        </div>
                    </div>
                </div>
            </div> 
            
            <div class="sheet-footer" id="ingame-sheet-footer">
                <button id="ingame-sheet-save-btn" class="sheet-btn">Salvar Ficha</button>
                <button id="ingame-sheet-load-btn" class="sheet-btn">Carregar Ficha</button>
                <input type="file" id="ingame-load-char-input" class="hidden" accept=".txt,.json">
            </div>
        </div>
    </div>

</div>

<!-- PAINEL DE DEPURA√á√ÉO -->
<div id="debug-panel" class="hidden"></div>

<script src="/socket.io/socket.io.js"></script>
<script src="client.js"></script>
</body>
</html>